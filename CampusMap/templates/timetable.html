{% extends "base.html" %}


{%block header%}


    <form class="col-md-9" role="form" xmlns="http://www.w3.org/1999/html">
        <div class="form-group">
            <div class="col-md-3">
              <select class="form-control" id="departmentSelect" >
                <option value=''>Select Department</option>
              </select>
            </div>

            <div class="col-md-3" id = "courses">
              <select class="form-control" id="courseSelect">
                <option value='0'>Select Course</option>
              </select>
            </div>

            <div class="col-md-2">
              <select class="form-control" id="yearSelect">
                <option value='0'>Select Year</option>

              </select>
            </div>

            <div class="col-md-2">
              <select class="form-control" id="semesterSelect">
                <option value='0'>Select Semester</option>
                <option value="1" >1</option>
                <option value="2" >2</option>
              </select>
            </div>

            <div class="col-md-2">
                <btn class="btn btn-primary" onclick="submit()">Submit</btn>
            </div>

        </div>
      </form>


{%endblock header%}
{%block content%}

<script src="{{ STATIC_URL }}js/table.js"></script>

<style>

table {
    width: 100%;
}

th {
    height: 60px;
    align: center;
}

</style>

<div class="container-fluid col-md-11"></div>

<div id="timetable" class="container-fluid col-md-11" style="margin:20px"></div>

<div id="cellModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Add a class to the timetable</h4>
            </div>
            <div class="modal-body" id="cellModalBody">


            <form id="cellModalForm" action='' method='post' class="form">{% csrf_token %}

                <div class="form-group"> <label for="timeTable" id="id_timeTable">Timetable</label>{{ form.timeTable }}</div>
                <div class="form-group"> <label for="day" id="id_day">Day</label>{{ form.day }}</div>
                <div class="form-group"> <label for="time" id="id_time">Time</label>{{ form.time }}</div>
                <div class="form-group"> <label for="modCode">Module Code</label>{{ form.modCode }}</div>
                <div class="form-group"> <label for="roomCode">Room Code</label>{{ form.roomCode }}</div>
                <div class="form-group"> <label for="lecCode">Lecturer Name</label>{{ form.lecCode }}</div>

            <!--</div>-->
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary">Save changes</button>
            </div>

            </form>
        </div>
    </div>
</div>


<script>

    window.onload=function(){
        getDepartments();

        //reloads the correct timetable after a class is added using the modal to allow you to enter multiple classes without having to filter the timetable out
        //values for course, year and sem are returned from views.py
        if (({{ check }})==true){
            loadTimetable('load','{{ course }}','{{ year }}','{{ sem }}')
        }

    }

    //Global variables to store data about timetable selected
    var department, course, year, semester;

    //Builds up URL to be sent as json request
    function buildURL(message, dept, course, year, semester){
        var msg = '../json/?message=' + message + "&department=" + dept + "&course=" + course + "&year=" + year + "&semester=" + semester;

        return msg;
    }

    //Gets a list of departments from the database
    function getDepartments(){
        var request = new XMLHttpRequest();
        var message = buildURL("departments",null,null,null,null)
        request.open('GET', message, false);
        request.send(null);

        departments = JSON.parse(request.responseText);

        sel = document.getElementById('departmentSelect');

        //Creates selects in department dropdown with onclick events that call getCourses for that department
        for(var i=0; i<departments.departments.length; i++){
            var op = document.createElement("option");
            op.innerHTML = "" + departments.departments[i];
            sel.setAttribute('onchange', 'onDepartmentSelection(this)');
            sel.appendChild(op);
        }
    }

    function onDepartmentSelection (select) {
        var selectedOption = select.options[select.selectedIndex]
        getCourses(selectedOption.value)
    }

    function getCourses(dept){

        department = dept;

        var request = new XMLHttpRequest();
        var message = buildURL("courses",dept,null,null,null);
        request.open('GET', message, false);  // `false` makes the request synchronous
        request.send(null);

        courses = JSON.parse(request.responseText);
        console.log(courses);

        sel = document.getElementById('courseSelect');

        //Clear dropdown each time a new department is chosen
        while(sel.firstChild){
            sel.removeChild(sel.firstChild);
        }

        //Set the first element in the dropdown
        var option = document.createElement("option");
        option.innerHTML = "Select a course";
        sel.appendChild(option);

        //Set every other element in the dropdown
        for(var i = 0; i<courses.courses.length; i++){
            var op = document.createElement("option");
            op.innerHTML = "" + courses.courses[i];
            //sel.setAttribute('onchange', 'OnSelectionChange(this)')
            sel.setAttribute('onchange', 'onCourseSelection(this)')
            sel.appendChild(op);
        }
    }

    function onCourseSelection (select) {
        var selectedOption = select.options[select.selectedIndex]
        getYears(selectedOption.value)
    }

    //Loads years by course. Allows for courses of various lengths without errors
    //ie: arts is 3 years long vs engineering is 4. This would throw an error when selected using the filters with static year values
    function getYears(course){
        var message = buildURL("years", null, course, null, null);
        var request = new XMLHttpRequest();
        request.open('GET', message, false);
        request.send(null);

        years = JSON.parse(request.responseText);

        sel = document.getElementById('yearSelect');

         while(sel.firstChild){
            sel.removeChild(sel.firstChild);
        }
        var option = document.createElement("option")
        option.innerHTML = "Select a year"
        sel.appendChild(option)

        //uses length of the request to generate year values, not the actual data in the request
        for(var i=0; i<years.years.length; i++){
            var op = document.createElement("option");
            op.innerHTML = i+1;
            sel.appendChild(op);
        }
    }

    //Onclick to load timetable when semester is chosen
    function submit(){
        sem = document.getElementById('semesterSelect');
        year = document.getElementById('yearSelect');
        course = document.getElementById('courseSelect');

        var val1 = course.options[course.selectedIndex].value;
        var val2 = year.options[year.selectedIndex].value;
        var val3 = sem.options[sem.selectedIndex].value;

        sem.setAttribute('onchange', loadTimetable(department,val1,val2,val3));

        year = val2;
        semester = val3;
    }

    //Loads the timetable
    function loadTimetable(department,course,year,semester){

        var request = new XMLHttpRequest();
        var message = buildURL("load",department,course,year,semester);
        request.open('GET', message, false);  // `false` makes the request synchronous
        request.send(null);

        timeTable = JSON.parse(request.responseText);

        retDiv = createTable(timeTable);

        el = document.getElementById("timetable");

        //Clears div when a new timetable is selected
        while (el.hasChildNodes()){
            el.removeChild(el.firstChild);
        }

        document.getElementById("timetable").appendChild(retDiv);

        var table = document.getElementsByTagName("table")[0];
        var cells = table.getElementsByTagName("td"); //

        //Adds onclick events to each cell to load the modal for data input
        for(var i = 0; i < cells.length; i++){
        // Cell Object
        var cell = cells[i];
        // Track with onclick
            cell.onclick = function(){
                $('#cellModal').modal('show');
            }
        }
    }
</script>

{%endblock%}