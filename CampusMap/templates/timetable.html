{% extends "base.html" %}


{%block header%}


      <form class="col-md-9" role="form">
        <div class="form-group">
            <div class="col-md-3">
              <select class="form-control" id="departmentSelect" >
                <option value=''>Select Department</option>
              </select>
            </div>

            <div class="col-md-3" id = "courses">
              <select class="form-control" id="courseSelect">
                <option value=''>Select Course</option>
              </select>
            </div>

            <div class="col-md-3">
              <select disabled class="form-control" id="yearSelect">
                <option value=''>Select Year</option>
              </select>
            </div>

            <div class="col-md-3">
              <select disabled class="form-control" id="semesterSelect">
                <option value=''>Select Semester</option>
              </select>
            </div>
        </div>
      </form>


{%endblock header%}
{%block content%}

<script src="{{ STATIC_URL }}js/table.js"></script>

<style>

table {
    width: 100%;
}

th {
    height: 60px;
    align: center;
}

</style>

<div class="container-fluid col-md-11"></div>

<div id="timetable" class="container-fluid col-md-11" style="margin:20px"></div>

<div id="cellModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Add a class to the timetable</h4>
            </div>
            <div class="modal-body" id="cellModalBody">


            <form id="cellModalForm" action='' method='post' class="form">{% csrf_token %}

                <!-- Always Hidden -->
                <div style="display: none">
                    {{ form.day }}
                    {{ form.time }}
                </div>

                <!-- Visible when creating new timetable -->
                <div id="newCourseOptions" style="display: none">
                    <div class="form-group"> <label for="courseCode">Course Code</label>{{ form.courseCode }}</div>
                    <div class="form-group"> <label for="year">Year</label>{{ form.year }}</div>
                    <div class="form-group"> <label for="semester">Semester</label>{{ form.semester }}</div>
                </div>

                <!-- Always visible -->
                <div class="form-group"> <label for="modCode">Module Code</label>{{ form.modCode }}</div>
                <div class="form-group"> <label for="roomCode">Room Code</label>{{ form.roomCode }}</div>
                <div class="form-group"> <label for="lecCode">Lecturer Name</label>{{ form.lecCode }}</div>

                <div class="checkbox"> <label><input type="checkbox"> Lab </label></div>

                <!--<button type="submit" class="btn btn-default">Submit</button>-->

            <!--</form>-->

            <!--</div>-->
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
            </form>
        </div>
    </div>
</div>


<script>

    window.onload=function(){
        getDepartments();

        if ({{ check }}){
            loadTimetable({{ course }});
        }
    }


    function getCourses(depShort){

        var request = new XMLHttpRequest();
        request.open('GET', '../json/?message='+depShort, false);  // `false` makes the request synchronous
        request.send(null);

        courses = JSON.parse(request.responseText);
        console.log(courses);

        sel = document.getElementById('courseSelect');

        //Clear dropdown each time a new department is chosen
        while(sel.firstChild){
            sel.removeChild(sel.firstChild);
        }

        //Set the first element in the dropdown
        var option = document.createElement("option");
        option.innerHTML = "Select a course";
        sel.appendChild(option);

        //Set every other element int the dropdown
        for(var i = 0; i<courses.courses.length; i++){
            var op = document.createElement("option");
            op.innerHTML = "" + courses.courses[i];
            sel.setAttribute('onchange', 'OnSelectionChange(this)')
            sel.appendChild(op);
        }
        //document.getElementById('courses').style.display = '';
    }

    function getDepartments(){
        var request = new XMLHttpRequest();
        request.open('GET', '../json/?message=departments', false);
        request.send(null);

        departments = JSON.parse(request.responseText);

        sel = document.getElementById('departmentSelect');

        for(var i=0; i<departments.departments.length; i++){
            var op = document.createElement("option");
            op.innerHTML = "" + departments.departments[i][0];
            op.setAttribute('onClick', 'getCourses('+"'"+departments.departments[i][1]+"'"+')');
            sel.appendChild(op);
        }
    }
    
    function OnSelectionChange (select) {
        var selectedOption = select.options[select.selectedIndex]
        loadTimetable(selectedOption.value)
    }

    function loadTimetable(course){

        var request = new XMLHttpRequest();
        request.open('GET', '../json/?message=' + course, false);  // `false` makes the request synchronous
        request.send(null);

        timeTable = JSON.parse(request.responseText);

        retDiv = createTable(timeTable);

        el = document.getElementById("timetable");

        while (el.hasChildNodes()){
            el.removeChild(el.firstChild);
        }

        document.getElementById("timetable").appendChild(retDiv);

        var table = document.getElementsByTagName("table")[0];
        var cells = table.getElementsByTagName("td"); //

        for(var i = 0; i < cells.length; i++){
        // Cell Object
        var cell = cells[i];
        // Track with onclick
            cell.onclick = function(){

                document.getElementById('id_courseCode').value = course;

                document.getElementById('id_day').value = this.getAttribute("day");

                document.getElementById('id_time').value = this.getAttribute("time");

                document.getElementById('id_year').value = '1';

                document.getElementById('id_semester').value = '2';

                $('#cellModal').modal('show');

            }
        }
    }
</script>

{%endblock%}